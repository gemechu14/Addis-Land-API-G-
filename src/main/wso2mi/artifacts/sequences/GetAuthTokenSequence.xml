<?xml version="1.0" encoding="UTF-8"?>
<sequence name="GetAuthTokenSequence" xmlns="http://ws.apache.org/ns/synapse">
    <!-- Store the original payload and properties -->
    <property name="ORIGINAL_PAYLOAD" expression="$body" scope="default" type="STRING"/>
    <property name="ORIGINAL_HTTP_METHOD" expression="$axis2:HTTP_METHOD" scope="default" type="STRING"/>
    <property name="ORIGINAL_REST_URL_POSTFIX" expression="$axis2:REST_URL_POSTFIX" scope="default" type="STRING"/>
    <property name="ORIGINAL_QUERY_STRING" expression="$axis2:QUERY_STRING" scope="default" type="STRING"/>
    <property name="ORIGINAL_CONTENT_TYPE" expression="$ctx:contentType" scope="default" type="STRING"/>
    
    <!-- Generate JWT token using Java mediator -->
    <class name="com.cbo.wso2.mediator.AddislandJWTGeneratorMediator"/>
    
    <!-- Fallback: To use Node.js service instead, uncomment below and comment out class mediator -->
    <!-- <call><endpoint key="TokenServiceEndpoint"/></call> -->
    <!-- <property name="JWT_TOKEN" expression="json-eval($.token)" scope="default" type="STRING"/> -->
    
    <!-- Check if token was generated -->
    <filter xpath="get-property('JWT_TOKEN') = '' or not(boolean(get-property('JWT_TOKEN')))">
        <then>
            <log level="custom">
                <property name="ERROR" value="Failed to generate JWT token"/>
            </log>
            <payloadFactory media-type="json">
                <format>{"error": "authentication_failed", "message": "Unable to generate authentication token"}</format>
                <args/>
            </payloadFactory>
            <property name="HTTP_SC" value="500" scope="axis2" type="STRING"/>
            <respond/>
        </then>
        <else>
            <log level="custom">
                <property name="MESSAGE" value="JWT token generated successfully"/>
            </log>
        </else>
    </filter>
    
    <!-- Restore the original payload -->
    <payloadFactory media-type="json">
        <format>$1</format>
        <args>
            <arg evaluator="xml" expression="get-property('ORIGINAL_PAYLOAD')"/>
        </args>
    </payloadFactory>
    
    <!-- Restore HTTP method and URL if they were changed -->
    <property name="HTTP_METHOD" expression="get-property('ORIGINAL_HTTP_METHOD')" scope="axis2" type="STRING"/>
    <property name="REST_URL_POSTFIX" expression="get-property('ORIGINAL_REST_URL_POSTFIX')" scope="axis2" type="STRING"/>
    <property name="QUERY_STRING" expression="get-property('ORIGINAL_QUERY_STRING')" scope="axis2" type="STRING"/>
</sequence>


