<?xml version="1.0" encoding="UTF-8"?>
<sequence name="GenerateInternalTokenSequence" xmlns="http://ws.apache.org/ns/synapse">
    <!-- 
        CRITICAL: DO NOT ACCESS $body HERE! 
        Reading $body forces message building which consumes the multipart stream.
        For multipart/form-data to work, we must never touch the body.
        Only store transport properties that don't trigger body access.
    -->
    <property name="ORIGINAL_HTTP_METHOD" expression="$axis2:HTTP_METHOD" scope="default" type="STRING"/>
    <property name="ORIGINAL_REST_URL_POSTFIX" expression="$axis2:REST_URL_POSTFIX" scope="default" type="STRING"/>
    <property name="ORIGINAL_QUERY_STRING" expression="$axis2:QUERY_STRING" scope="default" type="STRING"/>
    
    <log level="custom">
        <property name="MESSAGE" value="Generating JWT token using Java mediator"/>
    </log>
    
    <!-- Generate JWT token using Java mediator -->
    <class name="com.cbo.wso2.mediator.AddislandJWTGeneratorMediator"/>
    
    <!-- Check if token was generated -->
    <filter xpath="get-property('JWT_TOKEN') = '' or not(boolean(get-property('JWT_TOKEN')))">
        <then>
            <log level="custom">
                <property name="ERROR" value="Failed to generate JWT token"/>
                <property name="JWT_ERROR" expression="get-property('JWT_ERROR')"/>
            </log>
            <payloadFactory media-type="json">
                <format>{"error": "authentication_failed", "message": "Unable to generate authentication token internally"}</format>
                <args/>
            </payloadFactory>
            <property name="HTTP_SC" value="500" scope="axis2" type="STRING"/>
            <respond/>
        </then>
        <else>
            <log level="custom">
                <property name="MESSAGE" value="JWT token generated successfully via Java mediator"/>
            </log>
        </else>
    </filter>
    
    <!-- Restore HTTP method and URL if they were changed -->
    <property name="HTTP_METHOD" expression="get-property('ORIGINAL_HTTP_METHOD')" scope="axis2" type="STRING"/>
    <property name="REST_URL_POSTFIX" expression="get-property('ORIGINAL_REST_URL_POSTFIX')" scope="axis2" type="STRING"/>
    <property name="QUERY_STRING" expression="get-property('ORIGINAL_QUERY_STRING')" scope="axis2" type="STRING"/>
</sequence>


